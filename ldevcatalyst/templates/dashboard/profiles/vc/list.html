{% extends 'dashboard/base.html' %}
{% load static %}

{% block breadcrums %}
<!--begin::Breadcrumb-->
																<ul class="breadcrumb breadcrumb-separatorless fw-semibold">
																	<!--begin::Item-->
																	<li class="breadcrumb-item text-white fw-bold lh-1">
																		<a href="{% url 'dashboard_index' %}" class="text-white text-hover-primary">
																			<i class="ki-outline ki-home text-gray-700 fs-6"></i>
																		</a>
																	</li>
																	<!--end::Item-->
																	<!--begin::Item-->
																	<li class="breadcrumb-item">
																		<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
																	</li>
																	<!--end::Item-->
																	<!--begin::Item-->
																	<li class="breadcrumb-item text-white fw-bold lh-1">Profiles</li>
																	<!--end::Item-->
																	<!--begin::Item-->
																	<li class="breadcrumb-item">
																		<i class="ki-outline ki-right fs-7 text-gray-700 mx-n1"></i>
																	</li>
																	<!--end::Item-->
																	<!--begin::Item-->
																	<li class="breadcrumb-item text-white fw-bold lh-1">VC's</li>
																	<!--end::Item-->
																</ul>
																<!--end::Breadcrumb-->
{% endblock  %}

{% block pageheading %}
Profiles
{% endblock  %}
{% block pagedescription %}
VC's
{% endblock  %}



{% block page_content %}
							<div class="d-flex flex-column flex-column-fluid">
								<!--begin::Content-->
								<div id="kt_app_content" class="app-content flex-column-fluid">
									<!--begin::Contacts App- View Contact-->
									<div class="row g-7">
										<!--begin::Contact groups-->
										<div class="col-lg-6 col-xl-3">
											<!--begin::Contact group wrapper-->
											<div class="card card-flush">
												<!--begin::Card header-->
												<div class="card-header pt-7" id="kt_chat_contacts_header">
													<!--begin::Card title-->
													<div class="card-title">
														<h2>Categories</h2>
													</div>
													<!--end::Card title-->
												</div>
												<!--end::Card header-->
												<!--begin::Card body-->
												<div class="card-body pt-5">
													<!--begin::Contact groups-->
													<div class="d-flex flex-column gap-5">
														<!--begin::Contact group-->
														{% for x in areas_list%}
														<div class="d-flex flex-stack">
															<a href="#" class="fs-6 fw-bold text-gray-800 text-hover-primary text-active-primary active vc-cat-data="{{x.id}}" onclick="fetchVCProfiles('{{ x.id }}')"">{{x.name}}</a>
															<div class="badge badge-light-primary">{{x.count}}</div>
														</div>
														{%endfor%}
														
													</div>
													<!--end::Contact groups-->

												</div>
												<!--end::Card body-->
											</div>
											<!--end::Contact group wrapper-->
										</div>
										<!--end::Contact groups-->
										<!--begin::Search-->
										<div class="col-lg-6 col-xl-3">
											<!--begin::Contacts-->
											<div class="card card-flush" id="kt_contacts_list" style="display: none">
												
												<div class="card-body pt-5" id="kt_contacts_list_body">
													<!--begin::List-->
													<div class="scroll-y me-n5 pe-5 h-300px h-xl-auto" data-kt-scroll="true" data-kt-scroll-activate="{default: false, lg: true}" data-kt-scroll-max-height="auto" data-kt-scroll-dependencies="#kt_header, #kt_toolbar, #kt_footer, #kt_contacts_list_header" data-kt-scroll-wrappers="#kt_content, #kt_contacts_list_body" data-kt-scroll-stretch="#kt_contacts_list, #kt_contacts_main" data-kt-scroll-offset="5px" id="vc-profiles-list" style="display: none;">
														
													</div>
													<!--end::List-->
												</div>
												<!--end::Card body-->
											</div>
											<!--end::Contacts-->
										</div>
										<!--end::Search-->
										<!--begin::Content-->
										<div class="col-xl-6">
											<!--begin::Contacts-->
											<div class="card card-flush h-lg-100" id="kt_contacts_main" style="display:none;">
												<!--begin::Card header-->
												<div class="card-header pt-7" id="kt_chat_contacts_header">
													<!--begin::Card title-->
													<div class="card-title">
														<i class="ki-outline ki-badge fs-1 me-2"></i>
														<h2>VC Details</h2>
													</div>
													<!--end::Card title-->
													<!--begin::Card toolbar-->
													<div class="card-toolbar gap-3">
														{% comment %} <!--begin::Chat-->
														<button class="btn btn-sm btn-light btn-active-light-primary" data-kt-drawer-show="true" data-kt-drawer-target="#kt_drawer_chat">
														<i class="ki-outline ki-message-text-2 fs-2"></i>Chat</button>
														<!--end::Chat--> {% endcomment %}
														<!--begin::Chat-->
								
															{% if user.user_role == 6 %}
															<a href="#" id="sendMeetingRequest" class="btn btn-sm btn-light btn-active-light-primary" onclick="handleMeetingRequest()"> <i class="ki-outline ki-messages fs-2"></i>Send meeting request</a>
															{%endif%}
														<!--end::Chat-->
														{% comment %} <!--begin::Action menu-->
														<a href="#" class="btn btn-sm btn-icon btn-light btn-active-light-primary" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">
															<i class="ki-outline ki-dots-square fs-2"></i>
														</a>
														<!--begin::Menu-->
														<div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">

														</div>
														<!--end::Menu--> {% endcomment %}
														<!--end::Action menu-->
													</div>
													<!--end::Card toolbar-->
												</div>
												<!--end::Card header-->
												<!--begin::Card body-->
												<div class="card-body pt-5" id="vc_profile_data">

													
												</div>
												<!--end::Card body-->
											</div>
											<!--end::Contacts-->
										</div>
										<!--end::Content-->
									</div>
									<!--end::Contacts App- View Contact-->
								</div>
								<!--end::Content-->
							</div>
							<!--end::Content wrapper-->
							<!--begin::Footer-->
{% endblock %}


{% block custom_js %}
<script src="assets/js/custom/apps/contacts/view-contact.js"></script>
<script>

		function handleMeetingRequest() {
			var csrftoken = getCookie('csrftoken');
			var vcId = $("#vcid").data('vc-id'); // Get VC ID from data-vc-id attribute
			$.ajax({
				type: "POST",
				url: "{% url 'startup_vc_meeting_request' %}",
				data: {
					'vc_id': vcId,
					'csrfmiddlewaretoken': csrftoken
				},
				success: function(response) {
					if (response.success === 'true') {
						// Update link text and disable it
						$("#sendMeetingRequest").text('Meeting Request Sent');
						// Change class
						$("#sendMeetingRequest").addClass('btn-success').removeClass('btn-light btn-active-light-primary');
						// Prevent default behavior
						$("#sendMeetingRequest").removeAttr('onclick').click(function(event) {
							event.preventDefault();
						});
					} else {
						$("#sendMeetingRequest").text('Meeting Request failed');
						// Change class
						$("#sendMeetingRequest").addClass('btn-danger').removeClass('btn-light btn-active-light-primary');
						// Prevent default behavior
						$("#sendMeetingRequest").removeAttr('onclick').click(function(event) {
							event.preventDefault();
						});
					}
				},
				error: function(xhr, textStatus, errorThrown) {
					$("#sendMeetingRequest").text('Meeting Request failed');
						// Change class
						$("#sendMeetingRequest").addClass('btn-danger').removeClass('btn-light btn-active-light-primary');
						// Prevent default behavior
						$("#sendMeetingRequest").removeAttr('onclick').click(function(event) {
							event.preventDefault();
						});
				}
			});
		}

	function fetchVCProfiles(areaOfInterestId) {
        var csrftoken = getCookie('csrftoken'); // Function to retrieve CSRF token from cookies

        fetch('{% url "fetch_vc_profiles" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ area_category_id: areaOfInterestId })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            renderVCProfiles(data);
        })
        .catch(function(error) {
            console.error('Error fetching vc profiles:', error);
        });
    }

	function sanitizeHTML(html) {
		// Create a temporary element
		var temp = document.createElement('div');
		// Set the HTML content of the temporary element
		temp.innerHTML = html;
		// Get the text content of the temporary element
		var text = temp.textContent || temp.innerText;
		// Return the sanitized text
		return text;
	}
    function renderVCProfiles(profiles) {
		var main_section = document.getElementById('kt_contacts_list');
		var section = document.getElementById('vc-profiles-list');
		var details_section = document.getElementById('kt_contacts_main');
		section.innerHTML = '';
	
		if (Array.isArray(profiles) && profiles.length > 0) {
			// Remove display none if there are profiles to show
			section.style.display = 'block';
			main_section.style.display ='block';
			profiles.forEach(function(profile) {
				var profileHTML = `
				<div class="d-flex flex-stack py-4">
					<div class="d-flex align-items-center">
						<div class="symbol symbol-40px symbol-circle">
							<span class="symbol-label bg-light-danger text-danger fs-6 fw-bolder">${sanitizeHTML(DOMPurify.sanitize(profile.vc_id))}</span>
						</div>
						<div class="ms-4">
							<a href="#"  onclick="fetchVCDetails(${sanitizeHTML(DOMPurify.sanitize(profile.vc_id))})" class="fs-6 fw-bold text-gray-900 text-hover-primary mb-2">${sanitizeHTML(DOMPurify.sanitize(profile.firm_name))}</a>
							<div class="fw-semibold fs-7 text-muted">${sanitizeHTML(DOMPurify.sanitize(profile.funding_stage))}</div>
						</div>
					</div>
				</div>`;
	
				// Appending the profileHTML to the section
				section.innerHTML += profileHTML;
			});
		} else {
			section.style.display = 'none';
			main_section.style.display ='none';
			details_section.style.display = 'none';
		}
	}
	

	function fetchVCDetails(vcId) {
		const csrftoken = getCookie('csrftoken');
	
		fetch('{% url 'fetch_vc_details' %}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrftoken
			},
			body: JSON.stringify({
				vc_id: vcId
			})
		})
		.then(response => {
			if (!response.ok) {
				throw new Error('Failed to fetch vc details');
			}
			return response.json();
		})
		.then(data => {
			if (data.html) {
				// Check if meeting request is sent
				if (data.meeting_request_sent) {
					// Render the VC details HTML with meeting request sent status
					renderVCDetails(data.html);
					$("#sendMeetingRequest").text('Meeting Request Sent');
						// Change class
						$("#sendMeetingRequest").addClass('btn-success').removeClass('btn-light btn-active-light-primary');
						// Prevent default behavior
						$("#sendMeetingRequest").removeAttr('onclick').click(function(event) {
							event.preventDefault();
						});
				} else {
					$("#sendMeetingRequest").text('Send meeting request');
    				$("#sendMeetingRequest").attr('class', 'btn btn-sm btn-light btn-active-light-primary');
    				$("#sendMeetingRequest").attr('onclick', 'handleMeetingRequest()');
					renderVCDetails(data.html);
				}
			} else {
				throw new Error('No HTML data received');
			}
		})
		.catch(error => {
			console.error('Error fetching vc details:', error);
		});
	}
	
	
	// Function to render vc details HTML
	function renderVCDetails(html) {
		var main_section = document.getElementById('kt_contacts_main');
		main_section.style.display = 'block';
		// Update the HTML of the vc profile data element
		document.getElementById('vc_profile_data').innerHTML = html;
	}


	function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

</script>
{% endblock %}